{% extends "base.html" %}

    {% block title %} Чат {% endblock title %}

{% block content %}

<div id="more-text-here2"></div>

<div class="row">
    <p>REDIS : {{total_messeges}}</p>
{% for message in private_messages %}
    {% if message.author == user %}
     <div class="col-sm-1">       </div>
    <div class="col-sm-11">
        <div class="card py-0" >
            <div class="card-body py-0">
                <div class="row">
                    <dd class="col-sm my-0 text-right ">{{message.messages|safe}} </dd>
                    <dt class="col-sm-3 my-0 px-0 line text-center">Вы ({{message.author}}) <span class="badge badge-light">{{message.create_time}}</span></dt>
                </div>
            </div>
        </div>
    </div>
    {% else %}
   <div class="col-sm-11">
        <div class="card py-0" style='background-color: #F5FFFA;'>
            <div class="card-body py-0">
                <div class="row">
                    <dt class="col-sm-3 my-0 px-0 text-center">{{message.author}} <span class="badge" style='background-color: #F5FFFA;'>{{message.create_time}}</span></dt>
                    <dd class="col-sm my-0 line">{{message.messages|safe}}</dd>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-1">       </div>
    {% endif %}

{% endfor %}

    <div class="col-sm-11">
        <div class="card py-0 chat_card" style='background-color: #F5FFFA;' id="chat_card">
            <div class="card-body py-0" >
                <div class="row">
                    <dt class="col-sm-3 my-0 px-0 text-center"> </dt>
                    <dd class="col-sm my-0 line"></dd>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-1">       </div>



    <p id="update_message3"> </p>
</div>
<input type="hidden" name="total_messages" id="total_messages" value='{{total_messages}}'>
<input type="hidden" name="user_1" id="user_1" value='{{user_1}}'>
<input type="hidden" name="user_2" id="user_2" value='{{user_2}}'>

        <div class='col-md-8 mx-auto'>
            <form action="{% url 'dialogs:chat' user_1=user_1 user_2=user_2%}" method="post"> {% csrf_token %}
                {{form.as_p}}
                <button class="btn btn-primary btn-sm">Отправить</button>
            </form>
        </div>


{% endblock content %}

{% block javascript %}

    <script type="text/javascript">
        // var total_messeges = document.getElementById('total_messages').value;
        var user_1 = document.getElementById('user_1').value;
        var user_2 = document.getElementById('user_2').value;
        var i = 1;
        var timeOutId = 0;
        var ajaxFn = function () {
                $.ajax({
                    type: 'GET',
                    async: true,
                    url: '/ajax/',
                    data: {
                        'total_messages': document.getElementById('total_messages').value,
                        'user_1': user_1,
                        'user_2': user_2
                        },
                    success: function(data) {
                        //document.getElementById('update_message1').innerHTML=( data['private_messages'] + "&nbsp;\
                        //<span class='badge badge-light'>" + data['new_messages'] + "</span>"  );
                        document.getElementById('total_messages').value = data['total_messages']
                        if (data['message']){
                        let div2 = chat_card.cloneNode(true); // клонировать сообщение
                        div2.querySelector('dd').innerHTML = data['message'];
                        div2.querySelector('dt').innerHTML = ( data['author']+ "<span class='badge' style='background-color: #F5FFFA;;'>"+data['time']+"</span>");
                        chat_card.after(div2);
                        document.getElementById('chat_card').id = '-';
                        };
                    },
                    dataType: 'json',
                });
            };

        ajaxFn();
        timeOutId = setInterval(ajaxFn, 1000);

  </script>

{% endblock javascript %}